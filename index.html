<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rizal Review Quiz</title>

  <!-- jsPDF for PDF receipt generation -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --text:#e6e9f2; --muted:#aab3c5;
      --border:rgba(255,255,255,.10); --accent:#7c5cff;
      --good:#22c55e; --bad:#ef4444; --shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 20% 0%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(700px 500px at 90% 30%, rgba(34,197,94,.16), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .title{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;margin:8px 0 12px;}
    h1{margin:0;font-size:28px;letter-spacing:.2px}
    .subtitle{margin:6px 0 0;color:var(--muted);font-size:14px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin:12px 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .spacer{flex:1}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    select, button, .toggle, input{
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.65);
      color:var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    select{min-width:220px}
    button{cursor:pointer; transition: transform .06s ease, filter .2s ease, background .2s ease;}
    button:active{transform: scale(.99)}
    button.primary{
      background: linear-gradient(135deg, var(--accent), #4fd1c5);
      border-color: transparent;
      color:#081019;
      font-weight:900;
    }
    button.ghost{background: transparent;}
    button:disabled{opacity:.55;cursor:not-allowed;}
    .pills{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.55);
      border-radius:999px;
      font-size:13px;
      color:var(--text);
    }
    .pill strong{color:#fff}
    .bar{
      width:100%; height:10px; border-radius:999px; border:1px solid var(--border);
      background: rgba(15,23,42,.55); overflow:hidden; margin-top:10px;
    }
    .bar > div{
      height:100%; width:0%;
      background: linear-gradient(90deg, var(--accent), #4fd1c5);
      border-radius:999px;
      transition: width .35s ease;
    }
    .question-box{
      background: rgba(15,23,42,.45);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
    }
    .qhead{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px;}
    .qtitle{margin:0;font-size:16px;color:var(--muted)}
    .qtext{margin:0;font-size:18px;line-height:1.45}
    .choices{display:grid; gap:10px; margin-top:14px;}
    .choice{
      text-align:left; width:100%;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(17,26,46,.75);
      border:1px solid var(--border);
      display:flex; gap:10px; align-items:flex-start;
    }
    .choice:hover{filter: brightness(1.10)}
    .choice .key{
      flex:0 0 auto;
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(124,92,255,.16);
      border:1px solid rgba(124,92,255,.25);
      font-weight:900;
      color:#d9d2ff;
    }
    .choice.correct{border-color: rgba(34,197,94,.55); box-shadow: 0 0 0 3px rgba(34,197,94,.12);}
    .choice.wrong{border-color: rgba(239,68,68,.55); box-shadow: 0 0 0 3px rgba(239,68,68,.12);}
    .feedback{margin-top:12px;color:var(--muted);font-size:14px;min-height:18px;}

    .toast-wrap{position: fixed;top: 14px;right: 14px;display: grid;gap: 10px;z-index: 9999;}
    .toast{
      width: min(380px, calc(100vw - 28px));
      background: rgba(15,23,42,.92);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      display:flex; gap:10px; align-items:flex-start;
      animation: in .18s ease-out;
    }
    @keyframes in{from{transform: translateY(-6px); opacity:0}to{transform: translateY(0); opacity:1}}
    .dot{width:10px;height:10px;border-radius:999px;margin-top:4px;background: var(--accent);}
    .toast.good .dot{background: var(--good)}
    .toast.bad .dot{background: var(--bad)}
    .toast .t-title{font-weight:900;margin:0 0 2px 0}
    .toast .t-sub{margin:0;color:var(--muted);font-size:13px}

    .toggle{display:flex; gap:10px; align-items:center; padding:10px 12px;}
    .switch{width:44px;height:26px;border-radius:999px;background: rgba(255,255,255,.10);border:1px solid var(--border);position:relative;flex:0 0 auto;}
    .knob{width:20px;height:20px;border-radius:999px;background: #fff;position:absolute; top:2.5px; left:3px;transition: left .2s ease, background .2s ease;}
    .switch.on{background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.35)}
    .switch.on .knob{left:20px; background:#dcfce7}
    .small{font-size:13px;color:var(--muted)}

    /* Redeem area */
    .grid2{display:grid; gap:12px;}
    @media(min-width: 860px){ .grid2{grid-template-columns: 1.15fr .85fr;} }
    .box{
      background: rgba(15,23,42,.45);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .list{margin:10px 0 0; padding:0; list-style:none; display:grid; gap:8px;}
    .item{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      padding:10px 12px; border:1px solid var(--border); border-radius:14px;
      background: rgba(17,26,46,.65);
    }
    .item small{color:var(--muted)}
    iframe{
      width:100%;
      height:360px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(0,0,0,.2);
    }
    a.linkbtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      background: rgba(15,23,42,.65); color:var(--text); text-decoration:none;
    }

    /* ‚úÖ NEW: Rewards criteria panel */
    .criteria{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .criteria .citem{
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(17,26,46,.55);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .criteria .citem strong{font-weight:900}
    .badge{
      display:inline-flex; align-items:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(15,23,42,.55);
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="title">
    <div>
      <h1>Rizal Review Quiz</h1>
      <div class="subtitle">Session points keep adding until you refresh the page.</div>
    </div>
  </div>

  <div class="toast-wrap" id="toastWrap"></div>

  <div class="card">
    <div class="row">
      <div>
        <label for="limitSelect">Number of Questions</label>
        <select id="limitSelect">
          <option value="30">30 questions</option>
          <option value="50">50 questions</option>
          <option value="80">80 questions</option>
          <option value="120">120 questions</option>
          <option value="all">All Questions (Total Quantity)</option>
        </select>
      </div>

      <div class="toggle" id="autoNextToggle" style="min-width:220px">
        <div class="switch" id="autoNextSwitch" aria-label="Auto next">
          <div class="knob"></div>
        </div>
        <div>
          <div style="font-weight:900">Auto Next</div>
          <div class="small">After answering, go next</div>
        </div>
      </div>

      <div class="spacer"></div>
      <button class="primary" id="startBtn" style="min-width:150px">Start Quiz</button>
    </div>

    <div id="meta" class="small" style="margin-top:10px;"></div>
  </div>

  <!-- ‚úÖ Redeem reward area (always visible) -->
  <div class="card">
    <div class="grid2">
      <div class="box">
        <div class="row" style="justify-content:space-between;">
          <div class="pills">
            <span class="pill">Session Score: <strong id="sessionScorePillTop">0</strong></span>
            <span class="pill">Reward: <strong id="rewardPillTop">‚Äî</strong></span>
          </div>
          <div class="row">
            <button class="primary" id="redeemBtnTop" style="width:auto">Redeem Reward</button>
          </div>
        </div>

        <!-- ‚úÖ NEW: Rewards criteria -->
        <div style="margin-top:14px;">
          <div style="font-weight:900;">What are the rewards?</div>
          <div class="criteria" id="criteriaBox">
            <div class="citem"><div><strong>0‚Äì49 points</strong><div class="small">üç≠ 1 pc Lollipop ‚Äî Keep going!</div></div><div class="badge">Cost: 1</div></div>
            <div class="citem"><div><strong>50 points</strong><div class="small">üçü Fries</div></div><div class="badge">Cost: 50</div></div>
            <div class="citem"><div><strong>100 points</strong><div class="small">üçüüßã Fries with milk tea</div></div><div class="badge">Cost: 100</div></div>
            <div class="citem"><div><strong>150 points</strong><div class="small">üçΩÔ∏è Dinner</div></div><div class="badge">Cost: 150</div></div>
            <div class="citem"><div><strong>151+ points</strong><div class="small">üéÅ Whatever you want / requested</div></div><div class="badge">Cost: 151</div></div>
          </div>
          <div class="small" style="margin-top:8px;">Tip: Redeeming will deduct points based on the cost above.</div>
        </div>

        <div class="small" style="margin-top:14px;">
          Redemption History
        </div>
        <ul class="list" id="redeemList"></ul>
      </div>

      <div class="box">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:900;">Receipt Preview (PDF)</div>
            <div class="small">Click Redeem Reward to generate a receipt.</div>
          </div>
          <a class="linkbtn" id="downloadPdfLink" href="#" download="receipt.pdf" style="display:none;">Download PDF</a>
        </div>
        <div style="margin-top:10px;">
          <iframe id="receiptFrame" title="Receipt PDF preview"></iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="quizArea" style="display:none;">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="pills">
          <span class="pill" id="progressPill">Question 1 / 1</span>
          <span class="pill">Quiz Score: <strong id="scorePill">0</strong></span>
          <span class="pill">Session Score: <strong id="sessionScorePill">0</strong></span>
          <span class="pill">Session Answered: <strong id="sessionAnsweredPill">0</strong></span>
          <span class="pill">Reward: <strong id="rewardPill">‚Äî</strong></span>
        </div>

        <div class="row">
          <button id="redeemBtn" class="primary" style="width:auto">Redeem Reward</button>
          <button class="ghost" id="restartBtn" style="width:auto">Restart</button>
          <button class="primary" id="finishBtn" style="width:auto">Finish</button>
        </div>
      </div>
      <div class="bar"><div id="progressBar"></div></div>
    </div>

    <div class="card">
      <div class="question-box">
        <div class="qhead">
          <p class="qtitle" id="questionTitle"></p>
        </div>
        <p class="qtext" id="questionText"></p>
        <div class="choices" id="choices"></div>
        <div class="feedback" id="feedback"></div>
      </div>
    </div>

    <div class="card row" style="justify-content:space-between;">
      <button class="ghost" id="prevBtn" style="width:auto">‚Üê Previous</button>
      <button class="primary" id="nextBtn" style="width:auto">Next ‚Üí</button>
    </div>
  </div>

  <div id="resultArea" class="card" style="display:none;">
    <h2 style="margin-top:0">Result</h2>
    <p id="resultText" class="small"></p>
    <button class="primary" id="newQuizBtn" style="width:auto">New Quiz</button>
  </div>

</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://testkzelancwtyzlzcta.supabase.co";
  const SUPABASE_KEY = "sb_publishable_sVpwVVqwCGtfUHYM5IOkyg_uwzbfBtJ";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  const limitSelect = document.getElementById("limitSelect");
  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const finishBtn = document.getElementById("finishBtn");
  const newQuizBtn = document.getElementById("newQuizBtn");

  const redeemBtn = document.getElementById("redeemBtn");
  const redeemBtnTop = document.getElementById("redeemBtnTop");

  const meta = document.getElementById("meta");

  const quizArea = document.getElementById("quizArea");
  const resultArea = document.getElementById("resultArea");

  const progressPill = document.getElementById("progressPill");
  const scorePill = document.getElementById("scorePill");
  const sessionScorePill = document.getElementById("sessionScorePill");
  const sessionAnsweredPill = document.getElementById("sessionAnsweredPill");
  const rewardPill = document.getElementById("rewardPill");
  const progressBar = document.getElementById("progressBar");

  // top display
  const sessionScorePillTop = document.getElementById("sessionScorePillTop");
  const rewardPillTop = document.getElementById("rewardPillTop");
  const redeemList = document.getElementById("redeemList");
  const receiptFrame = document.getElementById("receiptFrame");
  const downloadPdfLink = document.getElementById("downloadPdfLink");

  const questionTitle = document.getElementById("questionTitle");
  const questionText = document.getElementById("questionText");
  const choicesDiv = document.getElementById("choices");
  const feedback = document.getElementById("feedback");

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  const toastWrap = document.getElementById("toastWrap");

  const autoNextToggle = document.getElementById("autoNextToggle");
  const autoNextSwitch = document.getElementById("autoNextSwitch");
  let autoNext = false;

  // Session totals
  let sessionScore = 0;
  let sessionAnswered = 0;

  // redemption log
  let redemptionHistory = []; // {id, date, item, cost, before, after, note}

  let lastMilestone = 0;

  let allQuestions = [];
  let questions = [];
  let index = 0;
  let score = 0;
  let answered = new Map();

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function showToast(type, title, subtitle) {
    const el = document.createElement("div");
    el.className = `toast ${type}`;
    el.innerHTML = `
      <div class="dot"></div>
      <div>
        <p class="t-title">${title}</p>
        <p class="t-sub">${subtitle || ""}</p>
      </div>
    `;
    toastWrap.appendChild(el);

    setTimeout(() => {
      el.style.opacity = "0";
      el.style.transform = "translateY(-4px)";
      el.style.transition = "all .2s ease";
    }, 1800);

    setTimeout(() => el.remove(), 2050);
  }

  // Reward mapping + costs
  function getReward(points) {
    if (points >= 151) return { tier: "151+", label: "üéÅ Whatever you want / requested", cost: 151 };
    if (points >= 150) return { tier: "150", label: "üçΩÔ∏è Dinner", cost: 150 };
    if (points >= 100) return { tier: "100", label: "üçüüßã Fries with milk tea", cost: 100 };
    if (points >= 50)  return { tier: "50",  label: "üçü Fries", cost: 50 };
    return { tier: "0-49", label: "üç≠ 1 pc Lollipop ‚Äî Keep going!", cost: 1 };
  }

  function maybeMilestoneToast(points) {
    const milestones = [49, 50, 100, 150, 151];
    for (const m of milestones) {
      if (points >= m && lastMilestone < m) {
        lastMilestone = m;
        if (m === 49) showToast("good", "Almost there! üî•", "You hit 49 points ‚Äî 1 more for Fries!");
        else if (m === 50) showToast("good", "Nice! üçü", "50 points unlocked ‚Äî Fries available to redeem!");
        else if (m === 100) showToast("good", "Amazing! üßã", "100 points unlocked ‚Äî Fries with milk tea!");
        else if (m === 150) showToast("good", "Legend! üçΩÔ∏è", "150 points unlocked ‚Äî Dinner!");
        else if (m === 151) showToast("good", "Boss level! üéÅ", "151+ points ‚Äî request anything you want!");
      }
    }
  }

  function renderRedeemList(){
    redeemList.innerHTML = "";
    if (redemptionHistory.length === 0) {
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<div><strong>No redemptions yet</strong><br><small>Your receipt will appear here after redeem.</small></div>`;
      redeemList.appendChild(li);
      return;
    }

    const latest = [...redemptionHistory].reverse().slice(0, 5);
    for (const r of latest) {
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `
        <div>
          <strong>${r.item}</strong><br>
          <small>${new Date(r.date).toLocaleString()}</small>
          ${r.note ? `<br><small>Note: ${r.note}</small>` : ""}
        </div>
        <div style="text-align:right">
          <div><strong>- ${r.cost} pts</strong></div>
          <small>${r.before} ‚Üí ${r.after}</small>
        </div>
      `;
      redeemList.appendChild(li);
    }
  }

  // generate PDF + preview
  function generateReceiptPDF(receipt){
    const jsPDF = window.jspdf?.jsPDF;
    if (!jsPDF) {
      showToast("bad", "PDF library not loaded", "Reload the page and try again.");
      return;
    }

    const doc = new jsPDF({ unit: "pt", format: "a4" });

    const left = 46;
    let y = 56;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Rizal Review Quiz - Redemption Receipt", left, y);

    y += 18;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.text(`Receipt ID: ${receipt.id}`, left, y);

    y += 16;
    doc.text(`Date: ${new Date(receipt.date).toLocaleString()}`, left, y);

    y += 22;
    doc.setDrawColor(200);
    doc.line(left, y, 550, y);

    y += 22;
    doc.setFont("helvetica", "bold");
    doc.text("Redeemed Item", left, y);
    doc.setFont("helvetica", "normal");
    y += 16;
    doc.text(`${receipt.item}`, left, y);

    if (receipt.note) {
      y += 16;
      doc.setFont("helvetica", "bold");
      doc.text("Note / Request", left, y);
      doc.setFont("helvetica", "normal");
      y += 16;
      doc.text(doc.splitTextToSize(receipt.note, 520), left, y);
      y += 10;
    }

    y += 14;
    doc.setFont("helvetica", "bold");
    doc.text("Points", left, y);
    doc.setFont("helvetica", "normal");
    y += 16;
    doc.text(`Cost: ${receipt.cost} point(s)`, left, y);
    y += 16;
    doc.text(`Points before: ${receipt.before}`, left, y);
    y += 16;
    doc.text(`Points after: ${receipt.after}`, left, y);

    y += 24;
    doc.setDrawColor(200);
    doc.line(left, y, 550, y);

    y += 22;
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.text("Thank you! Keep going and earn more rewards üéâ", left, y);

    const blob = doc.output("blob");
    const url = URL.createObjectURL(blob);

    receiptFrame.src = url;
    downloadPdfLink.href = url;
    downloadPdfLink.style.display = "inline-flex";
    downloadPdfLink.download = `receipt-${receipt.id}.pdf`;
  }

  function updateSessionUI(){
    sessionScorePill.textContent = String(sessionScore);
    sessionAnsweredPill.textContent = String(sessionAnswered);

    const reward = getReward(sessionScore);
    rewardPill.textContent = reward.label;

    sessionScorePillTop.textContent = String(sessionScore);
    rewardPillTop.textContent = reward.label;

    // ‚úÖ enable redeem only if user can afford at least 1 point (lollipop)
    const canRedeem = sessionScore >= 1;
    redeemBtn.disabled = !canRedeem;
    redeemBtnTop.disabled = !canRedeem;

    maybeMilestoneToast(sessionScore);
    renderRedeemList();
  }

  async function fetchAllQuestionsOnce() {
    meta.textContent = "Loading total questions...";
    const { data, error } = await supabase.from("questions").select("*");

    if (error) {
      meta.textContent = "";
      showToast("bad", "Cannot load questions", "Check Supabase RLS / key");
      console.error(error);
      return false;
    }

    allQuestions = data || [];
    meta.textContent = `Total Questions in Database: ${allQuestions.length}`;
    return true;
  }

  function pickQuestions() {
    const chosen = limitSelect.value;
    const shuffled = shuffle([...allQuestions]);
    if (chosen === "all") return shuffled;

    const n = Math.max(1, Number(chosen));
    return shuffled.slice(0, Math.min(n, shuffled.length));
  }

  function resetQuizOnly() {
    questions = [];
    index = 0;
    score = 0;
    answered = new Map();
    feedback.textContent = "";
    choicesDiv.innerHTML = "";
  }

  function renderQuestion() {
    const q = questions[index];
    if (!q) return;

    const total = questions.length;
    const current = index + 1;

    progressPill.textContent = `Question ${current} / ${total}`;
    scorePill.textContent = String(score);
    progressBar.style.width = `${Math.round((current / total) * 100)}%`;

    updateSessionUI();

    questionTitle.textContent = `Question ${current}`;
    questionText.textContent = q.question;

    const options = [
      { key: "A", text: q.choice_a },
      { key: "B", text: q.choice_b },
      { key: "C", text: q.choice_c },
      { key: "D", text: q.choice_d },
    ];

    const saved = answered.get(q.id);
    choicesDiv.innerHTML = "";
    feedback.textContent = "";

    for (const opt of options) {
      const btn = document.createElement("button");
      btn.className = "choice";
      btn.type = "button";
      btn.innerHTML = `<div class="key">${opt.key}</div><div>${opt.text}</div>`;

      if (saved) {
        btn.disabled = true;
        if (opt.key === q.correct_choice) btn.classList.add("correct");
        if (opt.key === saved.selected && !saved.correct) btn.classList.add("wrong");
      }

      btn.addEventListener("click", () => selectAnswer(opt.key));
      choicesDiv.appendChild(btn);
    }

    if (saved) {
      feedback.textContent = saved.correct
        ? "‚úÖ Correct! Great job."
        : `‚ùå Wrong. Correct answer is ${q.correct_choice}.`;
    }

    prevBtn.disabled = index === 0;
    nextBtn.disabled = index === total - 1;
  }

  function selectAnswer(letter) {
    const q = questions[index];
    if (!q) return;
    if (answered.has(q.id)) return;

    const correct = letter === q.correct_choice;
    answered.set(q.id, { selected: letter, correct });

    sessionAnswered += 1;

    if (correct) {
      score += 1;
      sessionScore += 1;
      showToast("good", "Congrats! üéâ", "You earned 1 point.");
    } else {
      showToast("bad", "Oops! üòÖ", `Correct answer: ${q.correct_choice}`);
    }

    renderQuestion();

    if (autoNext) {
      setTimeout(() => {
        if (index < questions.length - 1) {
          index++;
          renderQuestion();
        } else {
          finishQuiz();
        }
      }, 900);
    }
  }

  function redeemReward() {
    const reward = getReward(sessionScore);

    if (sessionScore < reward.cost) {
      showToast("bad", "Not enough points", `You need at least ${reward.cost} points.`);
      return;
    }

    let note = "";
    let item = reward.label;

    if (reward.tier === "151+") {
      const wish = prompt("üéÅ What do you want to request/redeem? (This will deduct 151 points)");
      if (!wish || !wish.trim()) {
        showToast("bad", "Canceled", "No request entered.");
        return;
      }
      note = wish.trim();
      item = "üéÅ Request Reward";
    }

    const before = sessionScore;
    sessionScore -= reward.cost;
    const after = sessionScore;

    const receipt = {
      id: (crypto?.randomUUID ? crypto.randomUUID().slice(0,8).toUpperCase() : String(Date.now()).slice(-8)),
      date: new Date().toISOString(),
      item,
      cost: reward.cost,
      before,
      after,
      note
    };

    redemptionHistory.push(receipt);

    showToast("good", "Redeemed! ‚úÖ", `Receipt generated: ${receipt.id}`);
    updateSessionUI();
    generateReceiptPDF(receipt);
  }

  function finishQuiz() {
    quizArea.style.display = "none";
    resultArea.style.display = "block";

    const total = questions.length;
    const percent = total ? ((score / total) * 100).toFixed(2) : "0.00";
    const msg = Number(percent) >= 75 ? "üéâ Passed! Keep it up!" : "üìö Keep reviewing ‚Äî you got this!";
    const reward = getReward(sessionScore);

    document.getElementById("resultText").innerHTML =
      `<strong>This Quiz:</strong> ${score} / ${total} (${percent}%)<br><br>
       <strong>Session Total Points:</strong> ${sessionScore}<br>
       <strong>Session Questions Answered:</strong> ${sessionAnswered}<br>
       <strong>Current Reward:</strong> ${reward.label}<br><br>
       ${msg}`;
  }

  async function startQuiz() {
    resultArea.style.display = "none";
    quizArea.style.display = "none";
    resetQuizOnly();

    if (allQuestions.length === 0) {
      const ok = await fetchAllQuestionsOnce();
      if (!ok) return;
    }

    questions = pickQuestions();
    if (questions.length === 0) {
      showToast("bad", "No questions found", "Upload questions first");
      return;
    }

    quizArea.style.display = "block";
    updateSessionUI();
    showToast("good", "Quiz started!", `Good luck ‚Äî ${questions.length} questions`);
    renderQuestion();
  }

  startBtn.addEventListener("click", startQuiz);
  restartBtn.addEventListener("click", startQuiz);
  finishBtn.addEventListener("click", finishQuiz);
  newQuizBtn.addEventListener("click", startQuiz);

  redeemBtn.addEventListener("click", redeemReward);
  redeemBtnTop.addEventListener("click", redeemReward);

  prevBtn.addEventListener("click", () => { if (index > 0) { index--; renderQuestion(); } });
  nextBtn.addEventListener("click", () => { if (index < questions.length - 1) { index++; renderQuestion(); } });

  autoNextToggle.addEventListener("click", () => {
    autoNext = !autoNext;
    autoNextSwitch.classList.toggle("on", autoNext);
    showToast("good", "Auto Next", autoNext ? "Enabled" : "Disabled");
  });

  // init
  fetchAllQuestionsOnce();
  updateSessionUI();
</script>

</body>
</html>
